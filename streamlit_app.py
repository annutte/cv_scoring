import streamlit as st
from openai import OpenAI
from parse_hh import get_html, extract_vacancy_data, extract_resume_data

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI-–∫–ª–∏–µ–Ω—Ç–∞
client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"]) 

SYSTEM_PROMPT = """
–†–∞—Å—Å—á–∏—Ç–∞–π –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 10, –Ω–∞—Å–∫–æ–ª—å–∫–æ –∫–∞–Ω–¥–∏–¥–∞—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–∏.
–ü—Ä–æ–≤–µ—Ä—å:
- —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ä–æ–ª–∏/—Å–µ–º–µ–π—Å—Ç–≤–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π –≤ cv –∏ –≤ –≤–∞–∫–∞–Ω—Å–∏–∏;
- —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ (–ø–æ–ª–Ω–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å/—á–∞—Å—Ç–∏—á–Ω–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å/—É–¥–∞–ª—ë–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç); 
- –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –Ω–∞–≤—ã–∫–æ–≤ –∏ —Å—Ç–µ–∫–∞. –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–µ —É–∫–∞–∑–∞–ª –Ω–∞–≤—ã–∫–∏, —Ç–æ —Å–º–æ—Ç—Ä–∏, –µ—Å—Ç—å –ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –≤ –æ–ø—ã—Ç–µ —Ä–∞–±–æ—Ç—ã;
- –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å —Ä–æ–ª–µ–π);
- —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã—Ö –æ–∂–∏–¥–∞–Ω–∏–π –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∏ –≤–∏–ª–∫–∏ –≤ –≤–∞–∫–∞–Ω—Å–∏–∏. –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–µ —É–∫–∞–∑–∞–ª –∑–∞—Ä–ø–ª–∞—Ç—É, —Ç–æ –∫–∞–Ω–¥–∏–¥–∞—Ç –º–æ–∂–µ—Ç –ø–æ–¥–æ–π—Ç–∏;
- —É—Å–∏–ª–∏–≤–∞—é—â–∏–µ —Å–∏–≥–Ω–∞–ª—ã (–ø—Ä–æ—Ñ–∏–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –Ω–∞–≤—ã–∫–∏);
- –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —Ä–µ–∑—é–º–µ.
–°–æ—Å—Ç–∞–≤—å –∫—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –æ–±—ä—è—Å–Ω—è—é—â–∏–π —Ç–≤–æ—é –æ—Ü–µ–Ω–∫—É.
–ü—Ä–µ–¥—Å—Ç–∞–≤—å –∏—Ç–æ–≥–æ–≤—É—é –æ—Ü–µ–Ω–∫—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 10.
""".strip()

def request_gpt(system_prompt, user_prompt):
    response = client.chat.completions.create(
        model="gpt-4.1-mini",
        messages=[
            {"role": "system", "content": system_prompt},  
            {"role": "user", "content": user_prompt},     
        ],
        max_tokens=1000,
        temperature=0,
    )
    return response.choices[0].message.content
# UI
st.title('CV Scoring App')
job_url = st.text_area('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é')
resume_url = st.text_area('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ä–µ–∑—é–º–µ')
if st.button("–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ"):
    with st.spinner("–ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ GPT..."):
        try:
            job_html = get_html(job_url).text
            resume_html = get_html(resume_url).text
            job_text = extract_vacancy_data(job_html)
            resume_text = extract_resume_data(resume_html)
            prompt = f"# –í–ê–ö–ê–ù–°–ò–Ø\n{job_text}\n\n# –†–ï–ó–Æ–ú–ï\n{resume_text}"
            response = request_gpt(SYSTEM_PROMPT, prompt)
            st.subheader("üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:")
            st.markdown(response)
        except Exception as e:
            st.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")